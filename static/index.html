<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Heddle & Loom Node Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/jsplumb@2.15.6/css/jsplumbtoolkit-defaults.css" rel="stylesheet">
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
        }
        
        #toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #2d2d2d;
            padding: 10px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        #canvas {
            margin-top: 60px;
            width: 100%;
            height: calc(100vh - 80px);
            position: relative;
            overflow: auto;
        }
        
        .node {
            position: absolute;
            background: #3d3d3d;
            border: 2px solid #555;
            border-radius: 8px;
            min-width: 200px;
            padding: 10px;
            cursor: move;
        }
        
        .node.root {
            background: #2d4f3c;
            border-color: #4CAF50;
        }
        
        .node-header {
            padding: 5px;
            background: #444;
            border-radius: 4px 4px 0 0;
            margin: -10px -10px 10px -10px;
            border-bottom: 1px solid #555;
        }
        
        .node-content {
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 100px;
            overflow-y: auto;
            margin: 5px 0;
            padding: 5px;
            background: #2a2a2a;
            border-radius: 4px;
        }
        
        .node-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        button {
            background: #4a4a4a;
            border: 1px solid #666;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #555;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        input,
        textarea {
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 5px;
            margin: 5px 0;
            border-radius: 4px;
            width: 100%;
        }
        
        .endpoint {
            width: 10px;
            height: 10px;
            background: #666;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="toolbar">
        <button onclick="showNewLoomModal()">New Loom</button>
        <span id="model-status">No model loaded</span>
    </div>

    <div id="canvas"></div>

    <!-- New Loom Modal -->
    <div class="modal" id="newLoomModal">
        <h3>Create New Loom</h3>
        <div>
            <label>Model Path:</label>
            <input type="text" id="modelPath" value="Llama-3.2-3B-Instruct-4bit">
        </div>
        <div>
            <label>Initial Prompt:</label>
            <textarea id="initialPrompt" rows="4">Write a story about...</textarea>
        </div>
        <div class="node-controls">
            <button onclick="createNewLoom()">Create</button>
            <button onclick="hideModals()">Cancel</button>
        </div>
    </div>

    <!-- Ramify Modal -->
    <div class="modal" id="ramifyModal">
        <h3>Ramify Node</h3>
        <div>
            <label>Custom Text (optional):</label>
            <input type="text" id="ramifyText" placeholder="Enter text or use generation parameters below">
        </div>
        <div>
            <label>Number of Generations:</label>
            <input type="number" id="ramifyN" value="3" min="1" max="10">
        </div>
        <div>
            <label>Temperature:</label>
            <input type="number" id="ramifyTemp" value="0.8" min="0" max="2" step="0.1">
        </div>
        <div>
            <label>Max Tokens:</label>
            <input type="number" id="ramifyMaxTokens" value="32" min="1">
        </div>
        <div class="node-controls">
            <button onclick="performRamify()">Ramify</button>
            <button onclick="hideModals()">Cancel</button>
        </div>
    </div>

    <div class="modal-backdrop" onclick="hideModals()"></div>

    <script src="https://cdn.jsdelivr.net/npm/jsplumb@2.15.6/dist/js/jsplumb.min.js"></script>
    <script>
        const BASE_URL = 'http://localhost:8000';

        // Helper: do a JSON POST request
        async function postJSON(url, data) {
            const response = await fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(data),
            });
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error ${response.status}: ${errorText}`);
            }
            return await response.json();
        }

        // Helper: do a GET request
        async function getJSON(url) {
            const response = await fetch(url);
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error ${response.status}: ${errorText}`);
            }
            return await response.json();
        }

        // 1) Load a Model
        async function loadModel() {
            const path = document.getElementById("load-model-path").value;
            const respBox = document.getElementById("load-model-response");
            respBox.textContent = "Loading model...";
            try {
                const data = await postJSON(`${BASE_URL}/load_model`, {
                    model_path: path
                });
                respBox.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                respBox.textContent = err.message;
            }
        }

        // 2) Create a Loom
        async function createLoom() {
            const modelId = document.getElementById("create-loom-modelid").value;
            const prompt = document.getElementById("create-loom-prompt").value;
            const respBox = document.getElementById("create-loom-response");
            respBox.textContent = "Creating loom...";
            try {
                const data = await postJSON(`${BASE_URL}/create_loom`, {
                    model_id: modelId,
                    prompt: prompt,
                });
                respBox.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                respBox.textContent = err.message;
            }
        }

        // 3) View a Loom (full subtree)
        async function viewLoom() {
            const loomId = document.getElementById("view-loom-id").value;
            const respBox = document.getElementById("view-loom-response");
            respBox.textContent = "Fetching loom subtree...";
            try {
                const data = await getJSON(`${BASE_URL}/loom/${loomId}`);
                respBox.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                respBox.textContent = err.message;
            }
        }

        // 4) View a Node
        async function viewNode() {
            const nodeId = document.getElementById("view-node-id").value;
            const respBox = document.getElementById("view-node-response");
            respBox.textContent = "Fetching node info...";
            try {
                const data = await getJSON(`${BASE_URL}/node/${nodeId}`);
                respBox.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                respBox.textContent = err.message;
            }
        }

        // 5) Ramify a Node
        async function ramifyNode() {
            const nodeId = document.getElementById("ramify-node-id").value;
            const ramifyText = document.getElementById("ramify-text").value;
            const n = parseInt(document.getElementById("ramify-n").value, 10);
            const temp = parseFloat(document.getElementById("ramify-temp").value);
            const max_tokens = parseInt(document.getElementById("ramify-max-tokens").value, 10);
            const respBox = document.getElementById("ramify-node-response");
            respBox.textContent = "Ramifying node...";
            try {
                const body = {
                    node_id: nodeId
                };
                if (ramifyText) {
                    // If text is provided, use that
                    body.text = ramifyText;
                } else {
                    // else use generation parameters
                    body.n = n;
                    body.temp = temp;
                    body.max_tokens = max_tokens;
                }
                const data = await postJSON(`${BASE_URL}/node/ramify`, body);
                respBox.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                respBox.textContent = err.message;
            }
        }

        // 6) Clip or Trim a Node
        async function clipNode() {
            const nodeId = document.getElementById("cliptrim-node-id").value;
            const limit = parseInt(document.getElementById("clip-limit").value, 10);
            const respBox = document.getElementById("cliptrim-response");
            respBox.textContent = "Clipping node...";
            try {
                const data = await postJSON(`${BASE_URL}/node/clip`, {
                    node_id: nodeId,
                    token_limit: limit
                });
                respBox.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                respBox.textContent = err.message;
            }
        }

        async function trimNode() {
            const nodeId = document.getElementById("cliptrim-node-id").value;
            const trimAmt = parseInt(document.getElementById("trim-amount").value, 10);
            const respBox = document.getElementById("cliptrim-response");
            respBox.textContent = "Trimming node...";
            try {
                const data = await postJSON(`${BASE_URL}/node/trim`, {
                    node_id: nodeId,
                    token_trim: trimAmt
                });
                respBox.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                respBox.textContent = err.message;
            }
        }

        // 7) View Node Subtree
        async function viewNodeSubtree() {
            const nodeId = document.getElementById("view-subtree-node-id").value;
            const respBox = document.getElementById("view-subtree-response");
            respBox.textContent = "Fetching node subtree...";
            try {
                const data = await getJSON(`${BASE_URL}/node/${nodeId}/subtree`);
                respBox.textContent = JSON.stringify(data, null, 2);
            } catch (err) {
                respBox.textContent = err.message;
            }
        }
    </script>
</body>

</html>